stages:
  - build
  - deploy

variables:
  NODE_ENV: production

before_script:
  - echo "‚è≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
  - npm ci

# –≠—Ç–∞–ø —Å–±–æ—Ä–∫–∏
build_app:
  stage: build
  image: node:20
  script:
    - echo "üîß –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
    - npm run build
  artifacts:
    paths:
      - .next
      - public
    expire_in: 1 hour

# –≠—Ç–∞–ø –¥–µ–ø–ª–æ—è
deploy_app:
  stage: deploy
  image: node:20
  only:
    - main
  before_script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H "$SERVER_IP" >> ~/.ssh/known_hosts
  script:
    - echo "üöÄ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
    - rsync -avz --delete \
        --exclude node_modules \
        --exclude .git \
        --exclude .gitignore \
        --exclude *.log \
        --exclude .env \
        ./ $SSH_USER@$SERVER_IP:$DEPLOY_PATH/
    - ssh $SSH_USER@$SERVER_IP << EOF
        set -ex
        cd $DEPLOY_PATH
        echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
        npm ci
        echo "üîß –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
        npm run build
        echo "üßπ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ PM2..."
        pm2 delete check24rf || true
        echo "üöÄ –ó–∞–ø—É—Å–∫ PM2..."
        npx pm2 start npm --name "check24rf" -- start -- --port $APP_PORT
        pm2 save
      EOF