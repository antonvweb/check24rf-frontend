name: ğŸš€ Deploy Dev Project

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.8.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸš€ Deploy and Start Dev Server
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            # ÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ°Ğ¿ĞºÑƒ
            mkdir -p ${{ secrets.DEPLOY_PATH }}

            # Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ½ĞµĞµ
            cd ${{ secrets.DEPLOY_PATH }}

            # Ğ¾Ñ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ¸ ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾
            rm -rf *
            exit
          EOF

          # ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
          rsync -avz --delete ./ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.DEPLOY_PATH }}

          # Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞµÑ€Ğ²ĞµÑ€
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH }}
            npm install
            # ÑƒĞ±Ğ¸Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ dev (Ğ³Ñ€ÑƒĞ±Ğ¾Ğ²Ğ°Ñ‚Ğ¾, Ğ½Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾)
            pkill -f "npm run dev" || true
            # Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ² Ñ„Ğ¾Ğ½Ğµ
            nohup npm run dev > output.log 2>&1 &
          EOF
