name: Deploy to Test Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      - name: üõ† Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üîê Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üß™ Debug ssh-agent
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö SSH-–∫–ª—é—á–µ–π:"
          ssh-add -l || echo "‚ùå –ö–ª—é—á–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã"

      - name: üß± Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
        continue-on-error: false

      - name: üîå Test SSH connection
        run: |
          echo "üîó –ü—Ä–æ–±—É–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} "echo ‚úÖ SSH connection established"

      - name: üîÑ Sync project to server
        run: |
          echo "üì§ –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
          rsync -avz --delete \
            --exclude node_modules \
            --exclude .git \
            --exclude .gitignore \
            --exclude *.log \
            --exclude .env \
            ./ ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:${{ secrets.DEPLOY_PATH }}/

      - name: üöÄ Build and deploy app on server
        run: |
          echo "üì° –ó–∞–ø—É—Å–∫–∞–µ–º —É–¥–∞–ª—ë–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã —á–µ—Ä–µ–∑ SSH..."
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            set -ex

            cd ${{ secrets.DEPLOY_PATH }}

            echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
            npm ci

            echo "üîß –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
            npm run build

            echo "üßπ –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ PM2..."
            pm2 delete check24rf-ip || true
            pm2 delete check24rf-domain || true

            echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è IP (–ø–æ—Ä—Ç 4000)..."
            npx pm2 start npm --name "check24rf-ip" -- run start:ip

            echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –¥–æ–º–µ–Ω–∞ (–ø–æ—Ä—Ç 3000)..."
            npx pm2 start npm --name "check24rf-domain" -- run start:domain

            pm2 save
          EOF
