name: Deploy to Test Server

on:
  push:
    branches:
      - main

env:
  SERVER_IP: ${{ secrets.SERVER_IP }} # –•—Ä–∞–Ω–∏–º IP –≤ —Å–µ–∫—Ä–µ—Ç–∞—Ö
  DEPLOY_PATH: /root/www/test/check24rf
  APP_PORT: 4000

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏

      - name: Setup Node.js
        uses: actions/setup-node@v4 # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js
        with:
          node-version: '20' # –£–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –≤–µ—Ä—Å–∏—é Node.js
          cache: 'npm' # –ö—ç—à–∏—Ä—É–µ–º node_modules

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0 # –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.SERVER_IP }} >> ~/.ssh/known_hosts
        continue-on-error: false # –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –æ—à–∏–±–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞

      - name: Sync project to server
        run: |
          rsync -avz --delete \
            --exclude node_modules \
            --exclude .git \
            --exclude .gitignore \
            --exclude *.log \
            --exclude .env \
            ./ root@${{ env.SERVER_IP }}:${{ env.DEPLOY_PATH }}/

      - name: Build and deploy app
        run: |
          ssh root@${{ env.SERVER_IP }} << 'EOF'
            set -e # –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ

            cd ${{ env.DEPLOY_PATH }}

            echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
            npm ci # –ò—Å–ø–æ–ª—å–∑—É–µ–º npm ci –¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏

            echo "üîß –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
            npm run build

            echo "üõë –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –Ω–∞ –ø–æ—Ä—Ç—É ${{ env.APP_PORT }}..."
            pkill -f "node.*${{ env.APP_PORT }}" || true # –ë–æ–ª–µ–µ –º—è–≥–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ

            echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å PM2..."
            npm install -g pm2 # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2 –≥–ª–æ–±–∞–ª—å–Ω–æ
            pm2 start npm --name "check24rf" -- start -- -p ${{ env.APP_PORT }}
            pm2 save # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é PM2
          EOF

      - name: Verify deployment
        run: |
          sleep 5 # –î–∞–µ–º –≤—Ä–µ–º—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
          response=$(curl --silent --write-out "%{http_code}" --output /dev/null http://${{ env.SERVER_IP }}:${{ env.APP_PORT }}/health || true)
          if [ "$response" -ne 200 ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç (HTTP $response)"
            exit 1
          else
            echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ"
          fi

      - name: Notify on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          slack-bot-token: ${{ secrets.SLACK_BOT_TOKEN }}
          channel-id: 'deploy-notifications'
          text: 'üö® Deployment to test server failed! Check GitHub Actions for details.'