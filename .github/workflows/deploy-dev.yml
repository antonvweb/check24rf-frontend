name: Deploy dev (Test)

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4

      - name: üõ† Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üîê Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üß™ Debug ssh-agent
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö SSH-–∫–ª—é—á–µ–π:"
          ssh-add -l || echo "‚ùå –ö–ª—é—á–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã"

      - name: üß± Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          # üëá –í–ê–ñ–ù–û: –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ—Ä—Ç 2222
          ssh-keyscan -H -p ${{ secrets.SSH_PORT || '2222' }} ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
        continue-on-error: false

      - name: üîå Test SSH connection
        run: |
          echo "üîó –ü—Ä–æ–±—É–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –Ω–∞ –ø–æ—Ä—Ç—É ${{ secrets.SSH_PORT || '2222' }}..."
          # üëá –í–ê–ñ–ù–û: —É–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Ä—Ç
          ssh -p ${{ secrets.SSH_PORT || '2222' }} \
              -o StrictHostKeyChecking=no \
              ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} \
              "echo ‚úÖ SSH connection established on port ${{ secrets.SSH_PORT || '2222' }}"

      - name: üîÑ Sync project to server
        run: |
          echo "üì§ –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–ø–æ—Ä—Ç ${{ secrets.SSH_PORT || '2222' }})..."
          # üëá –í–ê–ñ–ù–û: —É–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Ä—Ç –≤ rsync —á–µ—Ä–µ–∑ -e
          rsync -avz --delete \
            -e "ssh -p ${{ secrets.SSH_PORT || '2222' }}" \
            --exclude node_modules \
            --exclude .git \
            --exclude .gitignore \
            --exclude *.log \
            --exclude .env \
            --exclude .github \
            ./ ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:${{ secrets.DEPLOY_DEV_PATH }}/

      - name: üöÄ Deploy app (dev)
        run: |
          # üëá –í–ê–ñ–ù–û: —É–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Ä—Ç
          ssh -p ${{ secrets.SSH_PORT || '2222' }} \
              ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            set -ex
            cd ${{ secrets.DEPLOY_DEV_PATH }}
          
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ package.json
            if [ ! -f "package.json" ]; then
              echo "‚ùå package.json not found!"
              exit 1
            fi
          
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "üì¶ Installing dependencies..."
            npm ci
          
            # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
            echo "üèóÔ∏è Building project..."
            if grep -q '"build"' package.json; then
              npm run build
            else
              echo "‚ö†Ô∏è No build script found, skipping..."
            fi
          
            # –ó–∞–ø—É—Å–∫–∞–µ–º/–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º PM2
            echo "üîÑ Restarting PM2..."
            pm2 delete check24rf-domain 2>/dev/null || true
            pm2 start ecosystem.config.js --env dev
            pm2 save
          
            echo "üìä PM2 status:"
            pm2 list
          EOF